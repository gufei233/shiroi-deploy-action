name: Build and Deploy Shiroi (Standalone)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions: write-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HASH_FILE: build_hash

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    if: ${{ github.event.head_commit.message != 'Update hash file' }}

    outputs:
      hash_content: ${{ steps.read_hash.outputs.hash_content }}

    steps:
      - name: Checkout deploy repo
        uses: actions/checkout@v4

      - name: Read HASH_FILE content
        id: read_hash
        run: |
          content=$(cat ${{ env.HASH_FILE }}) || true
          echo "hash_content=$content" >> "$GITHUB_OUTPUT"

  check:
    name: Check Should Rebuild
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      canceled: ${{ steps.use_content.outputs.canceled }}
      current_hash: ${{ steps.use_content.outputs.current_hash }}

    steps:
      - name: Checkout Shiroi repo
        uses: actions/checkout@v4
        with:
          repository: innei-dev/shiroi
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          lfs: true

      - name: Compare hash
        id: use_content
        env:
          FILE_HASH: ${{ needs.prepare.outputs.hash_content }}
        run: |
          file_hash=$FILE_HASH
          current_hash=$(git rev-parse --short HEAD)
          echo "File Hash: $file_hash"
          echo "Current Git Hash: $current_hash"
          echo "current_hash=$current_hash" >> $GITHUB_OUTPUT

          if [ "$file_hash" == "$current_hash" ]; then
            echo "Hashes match. Stopping workflow."
            echo "canceled=true" >> $GITHUB_OUTPUT
          else
            echo "Hashes do not match. Continuing workflow."
          fi

  build:
    name: Build Shiroi
    runs-on: ubuntu-latest
    needs: check
    if: ${{ needs.check.outputs.canceled != 'true' }}

    strategy:
      matrix:
        node-version: [20.x]

    outputs:
      sha_short: ${{ steps.store.outputs.sha_short }}

    steps:
      - name: Checkout Shiroi repo
        uses: actions/checkout@v4
        with:
          repository: innei-dev/shiroi
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          lfs: true

      - name: Checkout LFS objects
        run: git lfs checkout

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Configure pnpm
        run: pnpm config set frozen-lockfile false

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build project
        run: pnpm --filter @shiro/web build

      - name: Prepare standalone bundle
        run: |
          cd apps/web/.next

          # æ¸…ç†ç¼“å­˜
          rm -rf cache diagnostics

          # æ£€æŸ¥ standalone ç›®å½•ç»“æž„
          echo "=== Checking standalone structure ==="
          ls -la standalone/

          # å®šä½ standalone ç›®å½•
          if [ -d "standalone/apps/web" ]; then
            STANDALONE_DIR="standalone/apps/web"
          elif [ -d "standalone" ]; then
            STANDALONE_DIR="standalone"
          else
            echo "Error: Cannot find standalone directory"
            exit 1
          fi

          echo "Using standalone dir: $STANDALONE_DIR"

          # å¤åˆ¶ public ç›®å½•
          if [ -d "../public" ]; then
            echo "Copying public..."
            mkdir -p $STANDALONE_DIR/public
            cp -r ../public/* $STANDALONE_DIR/public/
          fi

          # å¤åˆ¶ static ç›®å½•
          if [ -d "static" ]; then
            echo "Copying static..."
            mkdir -p $STANDALONE_DIR/.next/static
            cp -r static/* $STANDALONE_DIR/.next/static/
          fi

          # æ·»åŠ è¿›ç¨‹æ ‡é¢˜
          echo ';process.title = "Shiro (NextJS)"' >> $STANDALONE_DIR/server.js

          # æ‰“åŒ…æ•´ä¸ª standalone ç›®å½•ï¼ˆè€Œä¸æ˜¯ .nextï¼‰
          echo "=== Creating release archive ==="
          cd ..
          mkdir -p assets
          rm -rf assets/release.zip

          # æ‰“åŒ… standalone ç›®å½•ï¼ˆåŒ…å«å®Œæ•´çš„ node_modulesï¼‰
          cd .next/standalone
          zip -r ../../assets/release.zip ./* -x "*/cache/*" "*/.git/*"

          echo "=== Release created ==="
          ls -lh ../../assets/release.zip

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: apps/web/assets
          key: ${{ github.run_number }}-release

      - name: Store commit hash
        id: store
        run: |
          sha_short=$(git rev-parse --short HEAD)
          echo "sha_short=$sha_short" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: apps/web/assets
          key: ${{ github.run_number }}-release

      - name: Move release file
        run: mv apps/web/assets/release.zip release.zip

      - name: Upload to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: 'release.zip'
          target: '/tmp/shiroi'

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          command_timeout: 10m
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            source $HOME/.bashrc

            # é…ç½®è·¯å¾„
            BASEDIR=$HOME/Shiroi
            WORKDIR=$BASEDIR/releases/${{ github.run_number }}
            ENV_FILE=$BASEDIR/.env

            echo "ðŸ“¦ å¼€å§‹éƒ¨ç½² Shiroi..."

            # åˆ›å»ºå·¥ä½œç›®å½•
            mkdir -p $WORKDIR
            mkdir -p $BASEDIR/.cache

            # ç§»åŠ¨å¹¶è§£åŽ‹
            mv /tmp/shiroi/release.zip $WORKDIR/release.zip
            rm -rf /tmp/shiroi
            cd $WORKDIR
            echo "ðŸ“‚ è§£åŽ‹æž„å»ºäº§ç‰©..."
            unzip -qq -o release.zip
            rm release.zip

            # å®šä½ server.jsï¼ˆæ–°ç»“æž„ï¼šä»Ž standalone æ‰“åŒ…åŽç›´æŽ¥æ˜¯ apps/webï¼‰
            STANDALONE_DIR=$(find $WORKDIR -type f -name "server.js" -path "*/apps/web/server.js" | head -1 | xargs dirname)

            if [ -z "$STANDALONE_DIR" ]; then
              echo "âš ï¸  æœªæ‰¾åˆ° apps/web/server.jsï¼Œæ£€æŸ¥ç›®å½•ç»“æž„..."
              echo "ç›®å½•å†…å®¹ï¼š"
              find $WORKDIR -name "server.js" -type f
              ls -laR $WORKDIR | head -50
              exit 1
            fi

            echo "âœ“ æ‰¾åˆ° standalone ç›®å½•: $STANDALONE_DIR"

            # å¤åˆ¶ .env æ–‡ä»¶
            if [ ! -f "$ENV_FILE" ]; then
              echo "âŒ é”™è¯¯ï¼š$ENV_FILE ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º .env æ–‡ä»¶"
              exit 1
            fi

            echo "ðŸ“ å¤åˆ¶çŽ¯å¢ƒå˜é‡..."
            cp $ENV_FILE $STANDALONE_DIR/.env

            # å¤åˆ¶æˆ–åˆ›å»º PM2 é…ç½®
            if [ ! -f "$BASEDIR/ecosystem.config.cjs" ]; then
              echo "ðŸ“ åˆ›å»º PM2 é…ç½®..."
              cat > $BASEDIR/ecosystem.config.cjs << 'EOFPM2'
            module.exports = {
              apps: [{
                name: 'Shiro',
                script: './server.js',
                cwd: process.env.SHIROI_WORKDIR || '/root/Shiroi/current',
                instances: 1,
                exec_mode: 'cluster',
                env: {
                  NODE_ENV: 'production',
                  PORT: 2323,
                  HOSTNAME: '0.0.0.0',
                },
                error_file: '/root/Shiroi/logs/err.log',
                out_file: '/root/Shiroi/logs/out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss',
                merge_logs: true,
                max_memory_restart: '1G',
                autorestart: true,
                watch: false,
              }],
            }
            EOFPM2
            fi

            # åˆ›å»ºæ—¥å¿—ç›®å½•
            mkdir -p $BASEDIR/logs

            # é“¾æŽ¥ç¼“å­˜ç›®å½•ï¼ˆå¯é€‰ï¼ŒåŠ é€ŸåŽç»­æž„å»ºï¼‰
            if [ -d "$STANDALONE_DIR/.next" ]; then
              rm -rf $STANDALONE_DIR/.next/cache
              ln -sf $BASEDIR/.cache $STANDALONE_DIR/.next/cache
            fi

            # æ›´æ–° current ç¬¦å·é“¾æŽ¥
            echo "ðŸ”— æ›´æ–°å½“å‰ç‰ˆæœ¬é“¾æŽ¥..."
            rm -f $BASEDIR/current
            ln -sf $STANDALONE_DIR $BASEDIR/current

            # é‡å¯ PM2
            echo "ðŸ”„ é‡å¯æœåŠ¡..."
            cd $BASEDIR
            export SHIROI_WORKDIR=$STANDALONE_DIR

            # æ£€æŸ¥ PM2 è¿›ç¨‹æ˜¯å¦å­˜åœ¨
            if pm2 describe Shiro > /dev/null 2>&1; then
              pm2 restart ecosystem.config.cjs --update-env
            else
              pm2 start ecosystem.config.cjs
            fi

            pm2 save

            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ðŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
            pm2 status Shiro

            # æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘ 3 ä¸ªï¼‰
            echo "ðŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
            cd $BASEDIR/releases
            ls -t | tail -n +4 | xargs -r rm -rf

            echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼ç‰ˆæœ¬: ${{ github.run_number }}"

      - name: After deploy hook
        if: success()
        run: |
          echo "Deployment successful"
          ${{ secrets.AFTER_DEPLOY_SCRIPT }}

  store:
    name: Store commit hash
    runs-on: ubuntu-latest
    needs: [deploy, build]

    steps:
      - name: Checkout deploy repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Write hash to file
        env:
          SHA_SHORT: ${{ needs.build.outputs.sha_short }}
        run: echo $SHA_SHORT > ${{ env.HASH_FILE }}

      - name: Commit hash file
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ env.HASH_FILE }}
          git commit -m "Update hash file to ${{ needs.build.outputs.sha_short }}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
